<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>–ü—Ä–æ—Ñ–¢—Ä–µ–π–¥–õ–∞–± ‚Äî 8-bit Runner</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="46" fill="%2353B5AF"/><text x="50" y="70" text-anchor="middle" font-size="70" fill="black">üß™</text></svg>'>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{--brand:#53B5AF;--bg:#000;--card:#000;--text:#fff;--muted:#cfe9e7;--pad:12px;--app-height:100vh}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:monospace;background:var(--bg);color:var(--text)}
    #app-root{position:relative;width:100%;min-height:var(--app-height);display:flex}
    .wrap{flex:1;display:flex}
    .card{flex:1;display:flex;flex-direction:column;background:var(--card);border:3px solid var(--brand);image-rendering:pixelated;box-shadow:0 0 18px rgba(83,181,175,.35)}
    h1{font-size:20px;margin:0;padding:10px var(--pad);display:flex;align-items:center;gap:10px;background:linear-gradient(45deg, rgba(83,181,175,.10), rgba(83,181,175,.10));border-bottom:1px solid rgba(83,181,175,.35)}
    .gameBox{flex:1;display:flex;flex-direction:column;min-height:0}
    canvas{display:block;width:100%;height:auto;background:#000;image-rendering:pixelated;touch-action:manipulation;-webkit-user-select:none;user-select:none}
    .bar{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;padding:8px var(--pad);flex-wrap:wrap}
    .hint{font-size:12px;color:var(--muted)}
    .btn{background:#000;color:#fff;border:2px solid var(--brand);padding:8px 12px;cursor:pointer;border-radius:8px}
    .btn:active{background:var(--brand);color:#000}
    .btn.brand{background:var(--brand);color:#000;border-color:transparent}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;padding:16px;z-index:999;height:var(--app-height)}
    .panel{background:#fff;border:2px solid #e5e5e5;border-radius:10px;box-shadow:0 6px 28px rgba(0,0,0,.18);width:100%;max-width:860px;max-height:calc(var(--app-height) - 32px);display:flex;flex-direction:column}
    .panel .inner{display:grid;gap:14px;padding:16px;grid-template-columns:1fr 320px;overflow:auto}
    @media (max-width:740px){.panel .inner{grid-template-columns:1fr}}
    .field{margin:6px 0}
    #regOverlay label,#regOverlay h2,#regOverlay p{color:#000}
    #regOverlay input[type="text"],#regOverlay input[type="tel"],#regOverlay input[type="email"]{width:100%;background:#fff;border:2px solid #e5e5e5;color:#000;padding:8px;border-radius:6px;margin-top:4px}
    #regOverlay .checkbox{color:#000}
    #regOverlay .btn.brand,#resultOverlay .btn.brand{background:rgb(83,181,175);color:#000;border-color:transparent}
    #resultOverlay h2,#resultOverlay p,#resultOverlay b{color:#000}
    .qrbox{background:#fff;border:2px solid #e5e5e5;border-radius:10px;padding:12px;text-align:center}
    .qrbox h3{margin:0 0 10px;font-size:16px;color:#000}
    .qrbox img{max-width:100%;height:auto;display:block;margin:8px auto;border-radius:8px;border:1px solid #e5e5e5;background:#fff}
  </style>
</head>
<body>
  <div id="app-root">
    <div class="wrap">
      <div class="card">
        <h1>üß™ –ü—Ä–æ—Ñ–¢—Ä–µ–π–¥–õ–∞–± 8-bit Runner</h1>
        <div class="gameBox">
          <canvas id="game" width="1200" height="400"></canvas>
          <div class="bar">
            <div>–û—á–∫–∏: <span id="score">0</span> ¬∑ –†–µ–∫–æ—Ä–¥: <span id="best">0</span> ¬∑ –û—Å—Ç–∞–ª–æ—Å—å: <span id="timeLeft">02:00</span>
              <div class="hint">Space / ‚¨ÜÔ∏é / –¢–∞–ø ¬∑ –î–≤–æ–π–Ω–æ–π –ø—Ä—ã–∂–æ–∫ ‚Äî –≤—Ç–æ—Ä–æ–π —Å–ª–∞–±–µ–µ</div>
            </div>
            <div style="display:flex;gap:8px">
              <button id="restart" class="btn">–ó–∞–Ω–æ–≤–æ</button>
              <button id="newSession" class="btn brand">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (–æ—Ç–∫—Ä—ã—Ç–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ) -->
    <div id="regOverlay" class="overlay" style="display:flex">
      <div class="panel">
        <div class="inner">
          <div>
            <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <div class="field"><label>–§–∞–º–∏–ª–∏—è *</label><input id="lastName" type="text" required></div>
            <div class="field"><label>–ò–º—è *</label><input id="firstName" type="text" required></div>
            <div class="field"><label>–û—Ç—á–µ—Å—Ç–≤–æ <span class="note">(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span></label><input id="middleName" type="text"></div>
            <div class="field"><label>–¢–µ–ª–µ—Ñ–æ–Ω *</label><input id="phone" type="tel" placeholder="+7 900 000-00-00"></div>
            <div class="field"><label>Email</label><input id="email" type="email" placeholder="name@example.com"></div>
            <label class="checkbox"><input id="consent" type="checkbox"> –°–æ–≥–ª–∞—Å–µ–Ω –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</label>
            <div class="note">–î–∞–Ω–Ω—ã–µ –Ω—É–∂–Ω—ã –¥–ª—è –≤—ã–¥–∞—á–∏ –ø—Ä–∏–∑–∞ –∏ —Å–≤—è–∑–∏ —Å –≤–∞–º–∏.</div>

            <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap">
              <button id="fsBtn" type="button" class="btn">–í–æ –≤–µ—Å—å —ç–∫—Ä–∞–Ω</button>
              <button id="startBtn" class="btn brand">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            </div>
            <div id="regErr" style="color:#d50000;margin-top:6px"></div>
          </div>

          <div class="qrbox">
            <h3>–ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å –Ω–∞ –≥—Ä—É–ø–ø—É –ü—Ä–æ—Ñ–¢—Ä–µ–π–¥–õ–∞–±</h3>
            <img id="qrImg" src="" alt="QR –∫–æ–¥ –≥—Ä—É–ø–ø—ã">
            <div class="note">–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –ø–æ –∫–Ω–æ–ø–∫–µ</div>
            <button id="openGroup" class="btn brand" style="margin-top:8px">–û—Ç–∫—Ä—ã—Ç—å –≥—Ä—É–ø–ø—É</button>
          </div>
        </div>
      </div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–µ—Å—Å–∏–∏ -->
    <div id="resultOverlay" class="overlay">
      <div class="panel">
        <div class="inner" style="grid-template-columns:1fr">
          <div>
            <h2>–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞</h2>
            <p>–í–∞—à –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <b id="finalBest">0</b> –æ—á–∫–æ–≤.</p>
            <p>–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏: <b id="prizeText">‚Äî</b></p>
            <div style="margin-top:12px;display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap">
              <button id="toReg" class="btn">–ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</button>
              <button id="sendLead" class="btn brand">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // ========= CONFIG =========
  const ASSETS_BASE = 'assets/';
  const GROUP_URL   = 'https://t.me/proftradelab';
  // Web App URL (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ /exec)
  const SHEETS_URL  = 'https://script.google.com/macros/s/AKfycbzRHqPMrXs9p40gWvI-s4NIFM9snA2jtaDkIAe01x6La7YER3aWIYJ6oYJvpp21FtcC-Q/exec';
  // ==========================

  const tg = window.Telegram?.WebApp;
  try{ tg?.ready(); tg?.expand(); tg?.setBackgroundColor('#000'); tg?.setHeaderColor('secondary_bg_color'); }catch(e){}

  // QR
  document.getElementById('qrImg').src = ASSETS_BASE + 'qr_group.jpg';

  // –∞–¥–∞–ø—Ç–∞—Ü–∏—è –≤—ã—Å–æ—Ç—ã
  function setAppHeight(){ const vh=(window.visualViewport?.height)||innerHeight; document.documentElement.style.setProperty('--app-height', vh+'px'); }
  setAppHeight(); addEventListener('resize', setAppHeight); window.visualViewport?.addEventListener('resize', setAppHeight, {passive:true});

  // fullscreen –Ω–∞ —Ñ–æ—Ä–º–µ
  const fsBtn = document.getElementById('fsBtn');
  fsBtn.addEventListener('click', async () => {
    try{
      if(!document.fullscreenElement && !document.webkitFullscreenElement){
        const el=document.documentElement;
        if(el.requestFullscreen) await el.requestFullscreen(); else if(el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
        try{ await screen.orientation?.lock('landscape'); }catch(_){}
      }else{
        if(document.exitFullscreen) await document.exitFullscreen(); else if(document.webkitExitFullscreen) await document.webkitExitFullscreen();
      }
    }catch(e){}
  });
  document.addEventListener('fullscreenchange', ()=>{ fsBtn.textContent=(document.fullscreenElement||document.webkitFullscreenElement)?'–°–≤–µ—Ä–Ω—É—Ç—å':'–í–æ –≤–µ—Å—å —ç–∫—Ä–∞–Ω'; });

  // ======= –ò–ì–†–ê =======
  const canvas=document.getElementById('game'), ctx=canvas.getContext('2d');
  let W=canvas.width, H=canvas.height, GROUND_Y=H-32;
  function resizeCanvas(){
    const rect=canvas.parentElement.getBoundingClientRect();
    const cssW=Math.max(320, Math.floor(rect.width));
    const cssH=Math.max(220, Math.floor(Math.min(rect.height, innerHeight)*0.75));
    const dpr=Math.max(1, Math.min(2, devicePixelRatio||1));
    canvas.style.width=cssW+'px'; canvas.style.height=cssH+'px';
    canvas.width=Math.round(cssW*dpr); canvas.height=Math.round(cssH*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    W=cssW; H=cssH; GROUND_Y=H-32;
  }
  addEventListener('resize', resizeCanvas);

  function img(src){ const im=new Image(); im.src=src; return im }
  const bgTile=img(ASSETS_BASE+'background.png'); let bgOffset=0;
  function drawBg(){
    if(!bgTile.complete){ ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H); return }
    const scale=H/bgTile.height, tileW=Math.ceil(bgTile.width*scale), speed=worldSpeed*0.5;
    bgOffset=(bgOffset-speed); if(bgOffset<=-tileW) bgOffset+=tileW;
    for(let x=-tileW;x<W+tileW;x+=tileW) ctx.drawImage(bgTile,x+bgOffset,0,tileW,H);
  }

  const DECOS=[{img:img(ASSETS_BASE+'deco_clock.png'),w:64,h:64,weight:2},{img:img(ASSETS_BASE+'deco_panel.png'),w:80,h:80,weight:3},{img:img(ASSETS_BASE+'deco_console.png'),w:72,h:72,weight:1}];
  let bgDecos=[], MAX_DECOS=6, decoTimer=0, decoMin=1800, decoVar=2200;
  function pickDeco(){const t=DECOS.reduce((s,d)=>s+d.weight,0);let r=Math.random()*t;for(const d of DECOS){r-=d.weight;if(r<=0)return d}return DECOS[0]}
  function wallY(){const top=Math.round(H*0.20), bot=Math.round(H*0.45); return Math.floor(top+Math.random()*(bot-top))}
  function scheduleDeco(){decoTimer=(performance?.now?.()||Date.now())+decoMin+Math.random()*decoVar}
  function spawnDeco(now){ if(bgDecos.length>=MAX_DECOS) return; if(now>=decoTimer){const t=pickDeco(), s=0.85+Math.random()*0.4; bgDecos.push({x:W+40,y:wallY(),w:Math.round(t.w*s),h:Math.round(t.h*s),img:t.img}); scheduleDeco()} }
  function drawDecos(){const v=worldSpeed*0.5; for(let i=bgDecos.length-1;i>=0;i--){const d=bgDecos[i]; d.x-=v; if(d.img?.complete) ctx.drawImage(d.img,d.x,d.y,d.w,d.h); if(d.x<-d.w-20) bgDecos.splice(i,1)}}

  const playerSprites={run:[img(ASSETS_BASE+'player_run1.png'),img(ASSETS_BASE+'player_run2.png')], jump:img(ASSETS_BASE+'player_jump.png')};
  const RUN_MS=140; let animMs=0, animFrame=0, lastTs=performance?.now?.()||Date.now();
  function drawPlayer(){
    if(!player.onGround){ const j=playerSprites.jump; if(j?.complete) ctx.drawImage(j,player.x,player.y,player.w,player.h) }
    else { const now=performance?.now?.()||Date.now(), dt=Math.min(100,now-lastTs); lastTs=now; animMs+=dt; if(animMs>=RUN_MS){animMs-=RUN_MS; animFrame=(animFrame+1)%2} const r=playerSprites.run[animFrame]; if(r?.complete) ctx.drawImage(r,player.x,player.y,player.w,player.h) }
  }

  // —Ñ–∏–∑–∏–∫–∞ ‚Äî –ø–ª–∞–≤–Ω–æ–µ –ø–∞–¥–µ–Ω–∏–µ + –¥–≤–æ–π–Ω–æ–π –ø—Ä—ã–∂–æ–∫
  let GRAVITY=0.45, JUMP_V1=-12.2, JUMP_V2=-9.6, J2_WIN=420, J2_MINVY=1.2;
  const SESSION_LEN=120; let SPEED_START=4.4, TARGET=10.0; let SPEED_ACCEL=(TARGET-SPEED_START)/SESSION_LEN;
  let SPAWN_MIN=340, SPAWN_VAR=300;

  let worldSpeed=SPEED_START, score=0, best=0, ready=false, runStart=Date.now();
  let player={x:50,y:0,w:56,h:56,vy:0,onGround:true,jumpCount:0,firstAt:0};
  player.y=(H-32)-player.h;

  const SPRITES={HIGH:img(ASSETS_BASE+'obstacle_high.png'), WIDE:img(ASSETS_BASE+'obstacle_wide.png'), MEDIUM:img(ASSETS_BASE+'obstacle_medium.png'), FLY:img(ASSETS_BASE+'obstacle_fly.png')};
  let obstacles=[], spawnT=0, lastType=-1;
  function chooseType(){let pool=[0,1,2,3]; if(lastType!==-1) pool=pool.filter(t=>t!==lastType); const t=pool[(Math.random()*pool.length)|0]; lastType=t; return t}
  function spawnObstacle(){ const type=chooseType(); let w,h,y,sprite;
    if(type===0){w=56;h=56;sprite=SPRITES.MEDIUM;y=GROUND_Y-h}
    else if(type===1){w=96;h=56;sprite=SPRITES.WIDE;y=GROUND_Y-h}
    else if(type===2){w=52;h=104;sprite=SPRITES.HIGH;y=GROUND_Y-h}
    else {w=64;h=40;sprite=SPRITES.FLY;y=GROUND_Y-90-h; if(y<16) y=16}
    obstacles.push({x:W+10,y,w,h,sprite,type,passed:false});
  }
  const OB_W=0.82, OB_H=0.78, PL_W=0.80, PL_H=0.90, OBH_W=0.75, OBH_H=0.66;
  function pHit(p){const w=p.w*PL_W,h=p.h*PL_H,x=p.x+(p.w-w)/2,y=p.y+(p.h-h); return {x,y,w,h}}
  function oHit(o){ let w,h; if(o.type===2){w=o.w*OBH_W;h=o.h*OBH_H}else{w=o.w*OB_W;h=o.h*OB_H} const x=o.x+(o.w-w)/2; const isAir=o.y<(GROUND_Y-o.h); const y=isAir?(o.y+(o.h-h)/2):(o.y+(o.h-h)); return {x,y,w,h} }
  function overlap(a,b){ return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y }

  function jump(){
    if(!sessionActive() || !ready) return;
    if(player.onGround){ player.vy=JUMP_V1; player.onGround=false; player.jumpCount=1; player.firstAt=Date.now(); return }
    const since=Date.now()-player.firstAt;
    if(player.jumpCount===1 && since<=J2_WIN && player.vy<J2_MINVY){ player.vy=JUMP_V2; player.jumpCount=2 }
  }
  addEventListener('keydown',e=>{ if(e.code==='Space'||e.code==='ArrowUp'){e.preventDefault();jump()} if(e.code==='Enter' && !sessionActive()) showResults() });
  canvas.addEventListener('pointerdown', jump);

  let rafId=null;
  function loop(){ cancelAnimationFrame(rafId); rafId=requestAnimationFrame(update) }
  function update(){
    drawBg(); spawnDeco(performance?.now?.()||Date.now()); drawDecos();
    ctx.fillStyle='#53B5AF'; ctx.fillRect(0,GROUND_Y,W,2);

    if(!sessionActive()){ dim('–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞'); return }

    const elapsed=(Date.now()-runStart)/1000; worldSpeed=SPEED_START + SPEED_ACCEL*elapsed;

    spawnT -= worldSpeed; if(spawnT<=0){ spawnObstacle(); const bonus=(Math.random()<0.18)?160:0; spawnT = SPAWN_MIN + Math.random()*SPAWN_VAR + bonus }

    player.vy += GRAVITY; player.y += player.vy;
    if(player.y >= GROUND_Y-player.h){ player.y=GROUND_Y-player.h; player.vy=0; if(!player.onGround){ player.onGround=true; player.jumpCount=0 } } else player.onGround=false;

    for(let i=obstacles.length-1;i>=0;i--){
      const o=obstacles[i]; o.x -= worldSpeed;
      if(o.sprite?.complete) { ctx.imageSmoothingEnabled=false; ctx.drawImage(o.sprite,o.x,o.y,o.w,o.h) } else { ctx.fillStyle='#53B5AF'; ctx.fillRect(o.x,o.y,o.w,o.h) }
      if(o.x+o.w<0) obstacles.splice(i,1);
      if(!o.passed && o.x+o.w<player.x){ o.passed=true; score++; hud() }
      if(overlap(pHit(player), oHit(o))){ if(score>best){ best=score; hud() } softReset(true); break; }
    }

    drawPlayer();
    loop();
  }

  const scoreEl=document.getElementById('score'), bestEl=document.getElementById('best'), timeEl=document.getElementById('timeLeft');
  function hud(){ scoreEl.textContent=String(score); bestEl.textContent=String(best) }
  document.getElementById('restart').onclick=()=>{ if(!sessionActive()) return; countdown(()=>{ softReset(true) }) }
  document.getElementById('newSession').onclick=()=>openReg();

  const reg=document.getElementById('regOverlay'), result=document.getElementById('resultOverlay');
  const startBtn=document.getElementById('startBtn'), openGroupBtn=document.getElementById('openGroup'), toRegBtn=document.getElementById('toReg'), sendLeadBtn=document.getElementById('sendLead');
  const regErr=document.getElementById('regErr'), lastNameIn=document.getElementById('lastName'), firstNameIn=document.getElementById('firstName'), middleNameIn=document.getElementById('middleName'), phoneIn=document.getElementById('phone'), emailIn=document.getElementById('email'), consentIn=document.getElementById('consent');
  const finalBest=document.getElementById('finalBest'), prizeText=document.getElementById('prizeText');

  let profile=null, sessionEndAt=null, timerId=null;

  function openReg(){ regErr.textContent=''; reg.style.display='flex' }
  function closeReg(){ reg.style.display='none' }

  function normPhone(raw){ if(!raw) return ''; let d=raw.replace(/[^\d]/g,''); if(d.length===11&&d[0]==='8') d='7'+d.slice(1); if(d.length===10) d='7'+d; if(d.length===11&&d[0]==='7') return '+7'+d.slice(1); return '' }
  function emailOk(v){ if(!v) return true; return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(v.trim()) }

  startBtn.onclick=()=>{
    const lastName=lastNameIn.value.trim(), firstName=firstNameIn.value.trim(), middleName=middleNameIn.value.trim(), phoneRaw=phoneIn.value.trim(), email=emailIn.value.trim();
    if(!lastName){regErr.textContent='–£–∫–∞–∂–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é';return}
    if(!firstName){regErr.textContent='–£–∫–∞–∂–∏—Ç–µ –∏–º—è';return}
    const phone=normPhone(phoneRaw); if(!phone){regErr.textContent='–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω. –ü—Ä–∏–º–µ—Ä: +7 900 000-00-00';return}
    if(!consentIn.checked){regErr.textContent='–ù—É–∂–Ω–æ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö';return}
    if(!emailOk(email)){regErr.textContent='–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π e-mail';return}

    profile={lastName,firstName,middleName,phone,email};
    best=0; score=0; hud();

    sessionEndAt = Date.now() + 2*60*1000; // 2 –º–∏–Ω—É—Ç—ã
    closeReg();
    countdown(()=>{ hardReset(); tick(); });
  };

  openGroupBtn.onclick=()=>{ try{ tg ? tg.openLink(GROUP_URL,{try_instant_view:false}) : window.open(GROUP_URL,'_blank') }catch(e){} };
  toRegBtn.onclick=()=>{ result.style.display='none'; openReg() };

  // –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ —Ç–∞–±–ª–∏—Ü—É
  async function sendToSheets(payload){
    try{
      // –æ—Å–Ω–æ–≤–Ω–æ–π –ø—É—Ç—å —Å —á—Ç–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç–∞
      const res = await fetch(SHEETS_URL, {
        method: 'POST',
        headers: { 'Content-Type':'application/json; charset=UTF-8' },
        body: JSON.stringify(payload),
      });
      // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
      // const json = await res.json(); console.log('Sheets:', json);
    }catch(e){
      // –∑–∞–ø–∞—Å–Ω–æ–π –ø—É—Ç—å (–Ω–∞ —Å–ª—É—á–∞–π —Ä–µ–¥–∫–∏—Ö CORS-–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π)
      try{
        await fetch(SHEETS_URL, { method:'POST', mode:'no-cors', body: JSON.stringify(payload) });
      }catch(_){}
    }
  }

  // —Ä—É—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å —ç–∫—Ä–∞–Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
  sendLeadBtn.onclick=()=>{ autoSendAndBackToReg(); };

  function autoSendAndBackToReg(){
    const payload={ type:'lead', profile, best, ts:Date.now() };
    sendToSheets(payload);
    result.style.display='none';
    openReg();
  }

  function tick(){ clearInterval(timerId); timerId=setInterval(()=>{ const left=Math.max(0,(sessionEndAt||0)-Date.now()); timeEl.textContent=fmt(left); if(left<=0){ clearInterval(timerId); showResults() } },200) }
  function fmt(ms){ const s=Math.ceil(ms/1000), m=Math.floor(s/60), ss=('0'+(s%60)).slice(-2); return ('0'+m).slice(-2)+':'+ss }
  function sessionActive(){ return !!sessionEndAt && Date.now()<sessionEndAt }

  function showResults(){
    finalBest.textContent=String(best);
    prizeText.textContent=getPrize(best);
    // –∞–≤—Ç–æ-–æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    autoSendAndBackToReg();
  }
  function getPrize(p){ if(p>=70)return'–¢–µ—Ä–º–æ—Å'; if(p>=50)return'–®–æ–ø–ø–µ—Ä'; if(p>=30)return'–ë–ª–æ–∫–Ω–æ—Ç –∏ —Ä—É—á–∫–∞'; if(p>=20)return'–ë—Ä–µ–ª–æ–∫'; return '‚Äî' }

  function countdown(cb){ ready=false; let t=3; (function step(){ drawCountdown(t); if(t===0){ ready=true; cb&&cb(); return } setTimeout(()=>{ t--; step() },500) })() }
  function drawCountdown(n){ drawBg(); spawnDeco(performance?.now?.()||Date.now()); drawDecos(); ctx.fillStyle='#53B5AF'; ctx.fillRect(0,GROUND_Y,W,2); ctx.fillStyle='rgba(0,0,0,.35)'; ctx.fillRect(0,0,W,H); ctx.font='bold 56px monospace'; ctx.textAlign='center'; ctx.fillStyle='#53B5AF'; ctx.fillText(typeof n==='number'?n:' ', W/2, H/2) }
  function dim(msg){ ctx.fillStyle='rgba(0,0,0,.6)'; ctx.fillRect(0,0,W,H); ctx.font='16px monospace'; ctx.textAlign='center'; ctx.fillStyle='#fff'; ctx.fillText(msg, W/2, H/2) }

  function hardReset(){ runStart=Date.now(); score=0; softReset(true) }
  function softReset(clearScore){ if(clearScore){score=0; hud()} player.y=GROUND_Y-player.h; player.vy=0; player.onGround=true; player.jumpCount=0; animMs=0; animFrame=0; lastTs=performance?.now?.()||Date.now(); obstacles.length=0; spawnT=0; bgDecos.length=0; bgOffset=0; scheduleDeco(); loop() }

  resizeCanvas();
  // –ø–µ—Ä–≤—ã–π –∫–∞–¥—Ä ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –∑–µ–º–ª—é
  (function(){ ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H); ctx.fillStyle='#53B5AF'; ctx.fillRect(0,GROUND_Y,W,2) })();
})();
</script>
</body>
</html>
