<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>–ü—Ä–æ—Ñ–¢—Ä–µ–π–¥–õ–∞–± ‚Äî 8-bit Runner</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{--brand:#53B5AF;--bg:#000;--text:#fff;--app-h:100vh}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:monospace;background:var(--bg);color:var(--text)}
  #app{min-height:var(--app-h);display:flex;flex-direction:column}
  header{border-bottom:2px solid #1f3f3d;padding:8px 12px}
  .row{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px 12px}
  .hint{font-size:12px;opacity:.7}
  canvas{display:block;width:100%;height:auto;background:#000;touch-action:manipulation}
  .btn{border:2px solid var(--brand);background:#000;color:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
  .btn.brand{background:var(--brand);color:#000;border-color:transparent}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;z-index:10}
  .panel{background:#fff;color:#000;border:2px solid #e5e5e5;border-radius:10px;max-width:860px;width:calc(100% - 32px);padding:16px;display:grid;gap:12px;grid-template-columns:1fr 320px}
  @media (max-width:740px){.panel{grid-template-columns:1fr}}
  .field{display:grid;gap:6px}
  .field input{padding:8px;border:2px solid #e5e5e5;border-radius:8px}
  .qrbox{border:2px solid #e5e5e5;border-radius:10px;padding:12px;text-align:center}
  .qrbox img{max-width:100%;height:auto;border-radius:8px;border:1px solid #eee;background:#fff}
  .center{display:flex;justify-content:flex-end;gap:8px}
  .flash{position:fixed;inset:0;background:rgba(255,0,0,.25);pointer-events:none;opacity:0;transition:opacity .15s;z-index:9}
  .flash.show{opacity:1}
</style>
</head>
<body>
<div id="app">
  <header>üß™ –ü—Ä–æ—Ñ–¢—Ä–µ–π–¥–õ–∞–± 8-bit Runner</header>
  <canvas id="game" width="1200" height="420"></canvas>
  <div class="row">
    <div>
      –û—á–∫–∏: <b id="score">0</b> ¬∑ –†–µ–∫–æ—Ä–¥: <b id="best">0</b> ¬∑ –û—Å—Ç–∞–ª–æ—Å—å: <b id="left">02:00</b>
      <div class="hint">Space/‚¨Ü/—Ç–∞–ø ‚Äî –ø—Ä—ã–∂–æ–∫, –¥–≤–æ–π–Ω–æ–π –ø—Ä—ã–∂–æ–∫ ‚Äî –≤—Ç–æ—Ä–æ–π —Å–ª–∞–±–µ–µ</div>
    </div>
    <div>
      <button id="restart" class="btn">–ó–∞–Ω–æ–≤–æ</button>
      <button id="fullscreen" class="btn">–í–æ –≤–µ—Å—å —ç–∫—Ä–∞–Ω</button>
    </div>
  </div>
</div>

<!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏) -->
<div id="reg" class="overlay">
  <div class="panel">
    <div>
      <h3 style="margin:0 0 6px">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
      <div class="field"><label>–§–∞–º–∏–ª–∏—è *</label><input id="last" type="text"></div>
      <div class="field"><label>–ò–º—è *</label><input id="first" type="text"></div>
      <div class="field"><label>–û—Ç—á–µ—Å—Ç–≤–æ</label><input id="mid" type="text"></div>
      <div class="field"><label>–¢–µ–ª–µ—Ñ–æ–Ω *</label><input id="phone" type="tel" placeholder="+7 900 000-00-00"></div>
      <div class="field"><label>Email</label><input id="email" type="email" placeholder="name@example.com"></div>
      <label><input id="ok" type="checkbox"> –°–æ–≥–ª–∞—Å–µ–Ω –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</label>
      <div id="err" style="color:#c30000"></div>
      <div class="center" style="margin-top:8px">
        <button id="regSubmit" class="btn brand">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É</button>
      </div>
    </div>
    <div class="qrbox">
      <h4 style="margin:0 0 8px">–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –Ω–∞—à—É –≥—Ä—É–ø–ø—É</h4>
      <img id="qrImg" src="../assets/qr_group.jpg" alt="QR –≥—Ä—É–ø–ø—ã">
      <div class="hint" style="color:#000;margin-top:6px">–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É</div>
      <button id="openGroup" class="btn brand" style="margin-top:8px">–û—Ç–∫—Ä—ã—Ç—å –≥—Ä—É–ø–ø—É</button>
    </div>
  </div>
</div>

<!-- –ò—Ç–æ–≥–∏ —Å–µ—Å—Å–∏–∏ -->
<div id="done" class="overlay">
  <div class="panel" style="grid-template-columns:1fr">
    <div>
      <h3 style="margin:0 0 6px">–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞</h3>
      <p>–õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <b id="bestOut">0</b></p>
      <p>–ü—Ä–∏–∑: <b id="prizeOut">‚Äî</b></p>
      <div class="center">
        <button id="toReg" class="btn brand">–ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</button>
      </div>
    </div>
  </div>
</div>

<div id="flash" class="flash"></div>

<script>
(function(){
  const ASSETS_BASE = '../assets/'; // –ü–∞–ø–∫–∞ —Å –∞—Å—Å–µ—Ç–∞–º–∏
  const tg = window.Telegram && window.Telegram.WebApp;
  try{ tg?.ready(); tg?.expand(); tg?.setBackgroundColor("#000"); tg?.setHeaderColor("secondary_bg_color"); }catch(e){}

  // DOM
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const scoreEl = document.getElementById('score');
  const bestEl  = document.getElementById('best');
  const leftEl  = document.getElementById('left');
  const done    = document.getElementById('done');
  const bestOut = document.getElementById('bestOut');
  const prizeOut= document.getElementById('prizeOut');
  const reg     = document.getElementById('reg');
  const flash   = document.getElementById('flash');

  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
  const last = document.getElementById('last');
  const first= document.getElementById('first');
  const mid  = document.getElementById('mid');
  const phone= document.getElementById('phone');
  const email= document.getElementById('email');
  const ok   = document.getElementById('ok');
  const err  = document.getElementById('err');

  document.getElementById('toReg').onclick   = () => { done.style.display='none'; reg.style.display='flex'; };
  document.getElementById('openGroup').onclick = () => {
    const url = 'https://t.me/proftradelab';
    try { tg ? tg.openLink(url, {try_instant_view:false}) : window.open(url,'_blank'); } catch(e){}
  };
  document.getElementById('fullscreen').onclick = async () => {
    try{
      if (!document.fullscreenElement) await document.documentElement.requestFullscreen();
    }catch(e){}
    resize();
  };
  document.getElementById('regSubmit').onclick = () => {
    err.textContent='';
    const p = normPhone(phone.value);
    if (!last.value.trim())  return err.textContent='–£–∫–∞–∂–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é';
    if (!first.value.trim()) return err.textContent='–£–∫–∞–∂–∏—Ç–µ –∏–º—è';
    if (!p)                  return err.textContent='–¢–µ–ª–µ—Ñ–æ–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7 900 000-00-00';
    if (!ok.checked)         return err.textContent='–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ü–î';

    profile = {
      lastName: last.value.trim(),
      firstName:first.value.trim(),
      middleName: mid.value.trim(),
      phone: p,
      email: email.value.trim()
    };
    // –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –±–æ—Ç–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–Ω—É—Ç—Ä–∏ Telegram)
    try{
      if (tg) tg.sendData(JSON.stringify({type:'lead',profile,best,at:Date.now()}));
    }catch(e){}
    reg.style.display='none';
    startSession(); // –Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è
  };

  // –†–∞–∑–º–µ—Ä/–≤—ã—Å–æ—Ç–∞
  function setAppH(){
    const h = (window.visualViewport?.height) || window.innerHeight;
    document.documentElement.style.setProperty('--app-h', h+'px');
  }
  function resize(){
    setAppH();
    const dpr = Math.min(2, window.devicePixelRatio||1);
    const w = Math.max(800, Math.floor(document.body.clientWidth));
    const h = Math.floor(Math.min(window.innerHeight, document.body.clientHeight) * 0.72);
    canvas.style.width = w+'px';
    canvas.style.height= h+'px';
    canvas.width  = Math.round(w*dpr);
    canvas.height = Math.round(h*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    W = w; H = h; GROUND = H-32;
  }
  window.addEventListener('resize', resize);
  window.addEventListener('orientationchange', resize);

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (—Å —Ñ–æ–ª–±—ç–∫–æ–º)
  function load(src){ const im=new Image(); im.decoding='async'; im.src=ASSETS_BASE+src; return im; }
  function ready(im){ return im && im.complete && im.naturalWidth>0; }

  // –ê—Å—Å–µ—Ç—ã
  const bgTile = load('background.png');
  const DECOS = [
    {img: load('deco_clock.png'),   w:64, h:64, weight:2},
    {img: load('deco_panel.png'),   w:80, h:80, weight:3},
    {img: load('deco_console.png'), w:72, h:72, weight:1},
  ];
  const playerSprites = {
    run: [ load('player_run1.png'), load('player_run2.png') ],
    jump:  load('player_jump.png')
  };
  const SPRITES = {
    MEDIUM: load('obstacle_medium.png'),
    WIDE:   load('obstacle_wide.png'),
    HIGH:   load('obstacle_high.png'),
    FLY:    load('obstacle_fly.png')
  };

  // –ò–≥—Ä–∞
  let W=1200,H=420,GROUND=H-32;
  let mode='idle'; // idle / countdown / play / respawn / end
  let raf=0;

  // –§–∏–∑–∏–∫–∞ ‚Äî –ø–ª–∞–≤–Ω–µ–µ –ø–∞–¥–µ–Ω–∏–µ
  let GRAVITY = 0.68;
  const JUMP1  = -12.0;
  const JUMP2  = -9.0;
  const J2_WIN = 450;
  const J2_MIN = 1.2;

  // –°–∫–æ—Ä–æ—Å—Ç—å: –º–µ–¥–ª–µ–Ω–Ω—ã–π —Å—Ç–∞—Ä—Ç, —É—Å–∫–æ—Ä–µ–Ω–∏–µ –∫ –∫–æ–Ω—Ü—É
  let SPEED_START = 4.6;
  const SPEED_END   = 10.0;
  const SESSION_S   = 120;
  let SPEED_A = (SPEED_END - SPEED_START)/SESSION_S;

  const SPAWN_MIN = 340, SPAWN_VAR = 300;

  let world = SPEED_START;
  let score=0, best=0, runStart=0;
  let player = { x:56, y:GROUND-56, w:56, h:56, vy:0, on:true, jumps:0, t0:0 };
  let obs=[], spawn=0, lastType=-1;
  let bgDecos=[], decoTimer=0, bgOffset=0;
  let sessionEnd=0, tm=0;
  let animTime=0, frame=0;

  // —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–æ—Ç–ø—Ä–∞–≤–∫–∞
  let profile=null;

  // –°—Ç–∞—Ä—Ç –Ω–æ–≤–æ–π 2-–º–∏–Ω—É—Ç–Ω–æ–π —Å–µ—Å—Å–∏–∏
  function startSession(){
    score=0; best=0; updateHUD();
    leftEl.textContent='02:00';
    sessionEnd = Date.now()+SESSION_S*1000;
    resetWorld(true);             // –ø–æ–ª–Ω—ã–π —Ä–µ—Å–µ—Ç, —Å–∫–æ—Ä–æ—Å—Ç—å —Å –Ω–∞—á–∞–ª–∞
    startCountdown(3, () => beginPlay(true));
  }
  function beginPlay(fromStart=false){
    mode='play';
    runStart=Date.now();
    if (fromStart) world = SPEED_START;
    tickTimer();
    loop();
  }

  // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ (–Ω–µ –ø—Ä–∏ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–∏!)
  function endSession(){
    if (mode==='end') return;
    mode='end';
    bestOut.textContent = String(best);
    prizeOut.textContent= prize(best);
    done.style.display='flex';
  }

  // –†–µ—Å—Ç–∞—Ä—Ç –∑–∞–±–µ–≥–∞ –ø–æ—Å–ª–µ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è: –æ—á–∫–∏=0, –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –æ—á–∏—â–∞–µ–º, —Ç–∞–π–º–µ—Ä —Å–µ—Å—Å–∏–∏ –ù–ï —Ç—Ä–æ–≥–∞–µ–º
  function respawnRun(){
    mode='respawn';
    flash.classList.add('show');
    setTimeout(()=>flash.classList.remove('show'),150);

    score = 0; updateHUD();
    // —Å–∫–æ—Ä–æ—Å—Ç—å –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–π (—Å–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–∞—Å—Ç–µ—Ç –≤–º–µ—Å—Ç–µ —Å —Å–µ—Å—Å–∏–µ–π)
    obstaclesClear();
    player.y=GROUND-player.h; player.vy=0; player.on=true; player.jumps=0;
    animTime=0; frame=0;
    // –∫–æ—Ä–æ—Ç–∫–∞—è –ø–∞—É–∑–∞ 400 –º—Å –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏–≥—Ä—É
    setTimeout(()=>{ if(mode!=='end'){ mode='play'; loop(); } }, 400);
  }

  function obstaclesClear(){ obs.length=0; spawn=0; }

  // –ü–æ–ª–Ω—ã–π —Ä–µ—Å–µ—Ç –º–∏—Ä–∞ (–¥–ª—è —Å—Ç–∞—Ä—Ç–∞ —Å–µ—Å—Å–∏–∏)
  function resetWorld(resetSpeed){
    mode='countdown';
    if (resetSpeed) world=SPEED_START;
    obstaclesClear();
    bgDecos.length=0; bgOffset=0; scheduleNextDeco();
    player.y=GROUND-player.h; player.vy=0; player.on=true; player.jumps=0;
    drawFrame();
  }

  // –≥–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª
  function loop(){ cancelAnimationFrame(raf); raf=requestAnimationFrame(update); }
  function update(){
    drawFrame();

    if (mode==='play'){
      // —Ñ–∏–∑–∏–∫–∞ –∏–≥—Ä–æ–∫–∞
      player.vy += GRAVITY;
      player.y  += player.vy;
      if (player.y >= GROUND-player.h){ player.y = GROUND-player.h; player.vy=0; player.on=true; player.jumps=0; }
      else player.on=false;

      // —Å–∫–æ—Ä–æ—Å—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç –Ω–∞—á–∞–ª–∞ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
      const t = Math.max(0, (Date.now()- (sessionEnd-SESSION_S*1000)) / 1000); // –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è –≤ —Å–µ—Å—Å–∏–∏
      world = SPEED_START + SPEED_A*t;

      // —Å–ø–∞–≤–Ω –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π
      spawn -= world;
      if (spawn<=0){ spawnObstacle(); const bonus = Math.random()<0.18 ? 160 : 0; spawn = SPAWN_MIN + Math.random()*SPAWN_VAR + bonus; }

      // –¥–≤–∏–∂–µ–Ω–∏–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π + –∫–æ–ª–ª–∏–∑–∏–∏
      for (let i=obs.length-1;i>=0;i--){
        const o=obs[i]; o.x -= world;
        if (o.x+o.w<0) { obs.splice(i,1); continue; }
        if (!o.p && o.x+o.w<player.x){ o.p=true; score++; updateHUD(); }
        if (overlap(playerHit(player), obstacleHit(o))){
          respawnRun();           // ‚Üê —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –∑–∞–±–µ–≥ (–æ—á–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º)
          return;                 // –≤—ã—Ö–æ–¥–∏–º –∏–∑ update, –∫–∞–¥—Ä –∑–∞–≤–µ—Ä—à—ë–Ω
        }
      }

      loop();
    } else if (mode==='countdown' || mode==='respawn'){
      loop();
    }
  }

  // —Ñ–æ–Ω/–¥–µ–∫–æ—Ä–∞ –∏ –∏–≥—Ä–æ–∫
  function scheduleNextDeco(){ decoTimer = performance.now()+1800+Math.random()*2200; }
  function updateDecos(now){
    if (bgDecos.length<6 && now>=decoTimer){
      const t = pickDecoByWeight();
      const s = 0.85+Math.random()*0.4;
      bgDecos.push({x:W+40,y:randWallY(),w:Math.round(t.w*s),h:Math.round(t.h*s),img:t.img});
      scheduleNextDeco();
    }
  }
  function pickDecoByWeight(){ const tot=DECOS.reduce((s,d)=>s+d.weight,0); let r=Math.random()*tot; for(const d of DECOS){ r-=d.weight; if(r<=0) return d; } return DECOS[0]; }
  function randWallY(){ const top=Math.round(H*0.20), bottom=Math.round(H*0.45); return Math.floor(top+Math.random()*(bottom-top)); }

  function drawFrame(){
    // —Ñ–æ–Ω
    if (ready(bgTile)){
      const scale = H/bgTile.naturalHeight;
      const tileW = Math.ceil(bgTile.naturalWidth*scale);
      const speed = world*0.5;
      bgOffset = (bgOffset - speed);
      if (bgOffset<=-tileW) bgOffset += tileW;
      for (let x=-tileW; x<W+tileW; x+=tileW) ctx.drawImage(bgTile,x+bgOffset,0,tileW,H);
    } else {
      ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H);
    }

    // –¥–µ–∫–æ—Ä–∞
    updateDecos(performance.now());
    const bgSpeed=world*0.5;
    for (let i=bgDecos.length-1;i>=0;i--){
      const d=bgDecos[i]; d.x-=bgSpeed;
      if (ready(d.img)) { ctx.imageSmoothingEnabled=false; ctx.drawImage(d.img,d.x,d.y,d.w,d.h); }
      if (d.x<-d.w-20) bgDecos.splice(i,1);
    }

    // –∑–µ–º–ª—è
    ctx.fillStyle='#53B5AF'; ctx.fillRect(0,GROUND,W,2);

    // –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
    for (const o of obs){
      const spr = spriteFor(o.t);
      if (ready(spr)) ctx.drawImage(spr,o.x,o.y,o.w,o.h);
      else { ctx.fillStyle='#53B5AF'; ctx.fillRect(o.x,o.y,o.w,o.h); }
    }

    // –∏–≥—Ä–æ–∫ ‚Äî —Å–ø—Ä–∞–π—Ç—ã –±–µ–≥/–ø—Ä—ã–∂–æ–∫
    const inAir = player.y < GROUND - player.h;
    if (inAir && ready(playerSprites.jump)){
      ctx.drawImage(playerSprites.jump, player.x, player.y, player.w, player.h);
    } else {
      const now = performance.now();
      const dt = Math.min(100, now - runTimer); runTimer = now;
      animTime += dt; if (animTime>=RUN_MS){ animTime-=RUN_MS; frame=(frame+1)%2; }
      const im = playerSprites.run[frame];
      if (ready(im)) ctx.drawImage(im, player.x, player.y, player.w, player.h);
      else { ctx.fillStyle='#a3e635'; roundRect(ctx, player.x, player.y, player.w, player.h, 6); ctx.fill(); }
    }

    // –æ–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á—ë—Ç –ø–æ–≤–µ—Ä—Ö
    if (mode==='countdown' && !countReady){
      ctx.fillStyle='rgba(0,0,0,.35)'; ctx.fillRect(0,0,W,H);
      ctx.fillStyle='#53B5AF'; ctx.font='bold 56px monospace'; ctx.textAlign='center';
      ctx.fillText(countVal>0?countVal:'', W/2, H/2);
    }
  }
  let runTimer=performance.now();
  const RUN_MS=140;
  function spriteFor(t){ return t===0?SPRITES.MEDIUM : t===1?SPRITES.WIDE : t===2?SPRITES.HIGH : SPRITES.FLY; }
  function roundRect(c,x,y,w,h,r){const rr=Math.min(r,w/2,h/2);c.beginPath();c.moveTo(x+rr,y);c.arcTo(x+w,y,x+w,y+h,rr);c.arcTo(x+w,y+h,x,y+h,rr);c.arcTo(x,y+h,x,y,rr);c.arcTo(x,y,x+w,y,rr);c.closePath();}

  // –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
  function spawnObstacle(){
    const t = chooseType();
    let w,h,y;
    if (t===0){w=56;h=56;y=GROUND-h;}
    else if(t===1){w=96;h=56;y=GROUND-h;}
    else if(t===2){w=52;h=104;y=GROUND-h;}
    else {w=64;h=40;y=GROUND-90-h; if (y<16) y=16;}
    obs.push({x:W+10,y,w,h,t,p:false});
  }
  function chooseType(){ let pool=[0,1,2,3]; if (lastType!==-1) pool=pool.filter(v=>v!==lastType); const t=pool[(Math.random()*pool.length)|0]; lastType=t; return t; }

  // —Ö–∏—Ç–±–æ–∫—Å—ã
  function playerHit(p){ const pw=p.w*0.80, ph=p.h*0.90; return {x:p.x+(p.w-pw)/2,y:p.y+(p.h-ph),w:pw,h:ph}; }
  function obstacleHit(o){
    const isHigh=o.t===2, ow=o.w*(isHigh?0.75:0.82), oh=o.h*(isHigh?0.66:0.78);
    const ox=o.x+(o.w-ow)/2; const isAir=o.y<(GROUND-o.h); const oy=isAir?(o.y+(o.h-oh)/2):(o.y+(o.h-oh));
    return {x:ox,y:oy,w:ow,h:oh};
  }
  function overlap(a,b){ return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y; }

  // —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ / –ø—Ä—ã–∂–∫–∏
  window.addEventListener('keydown', e=>{
    if (e.code==='Space'||e.code==='ArrowUp'){ e.preventDefault(); jump(); }
    if (e.code==='Enter' && mode==='end'){ done.style.display='none'; reg.style.display='flex'; }
  });
  canvas.addEventListener('pointerdown', jump);
  function jump(){
    if (mode!=='play') return;
    if (player.on){ player.vy=JUMP1; player.on=false; player.jumps=1; player.t0=Date.now(); return; }
    const dt=Date.now()-player.t0;
    if (player.jumps===1 && dt<=J2_WIN && player.vy<J2_MIN){ player.vy=JUMP2; player.jumps=2; }
  }

  // —Ç–∞–π–º–µ—Ä —Å–µ—Å—Å–∏–∏
  function tickTimer(){
    clearInterval(tm);
    tm=setInterval(()=>{
      const left=Math.max(0, sessionEnd-Date.now());
      leftEl.textContent = fmt(left);
      if (left<=0){ clearInterval(tm); endSession(); }
    },200);
  }
  function fmt(ms){const s=Math.ceil(ms/1000), m=(s/60)|0, ss=('0'+(s%60)).slice(-2); return ('0'+m).slice(-2)+':'+ss;}

  // –æ–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á—ë—Ç
  let countVal=3, countReady=false;
  function startCountdown(n, cb){
    mode='countdown'; countReady=false; countVal=n;
    const step=()=>{ drawFrame(); if(countVal===0){ countReady=true; cb&&cb(); return; } setTimeout(()=>{countVal--; step();},500); };
    step();
  }

  // HUD/–ø—Ä–æ—á–µ–µ
  function updateHUD(){ scoreEl.textContent=score; best=Math.max(best,score); bestEl.textContent=best; }
  function prize(p){ if(p>=70)return'–¢–µ—Ä–º–æ—Å'; if(p>=50)return'–®–æ–ø–ø–µ—Ä'; if(p>=30)return'–ë–ª–æ–∫–Ω–æ—Ç –∏ —Ä—É—á–∫–∞'; if(p>=20)return'–ë—Ä–µ–ª–æ–∫'; return '‚Äî'; }
  function normPhone(v){
    if(!v) return '';
    let d = v.replace(/[^\d]/g,'');
    if (d.length===11 && d[0]==='8') d='7'+d.slice(1);
    if (d.length===10) d='7'+d;
    if (d.length===11 && d[0]==='7') return '+7'+d.slice(1);
    return '';
  }

  // –ö–Ω–æ–ø–∫–∞ ¬´–ó–∞–Ω–æ–≤–æ¬ª ‚Äî –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π —Ä–µ—Å—Ç–∞—Ä—Ç –∑–∞–±–µ–≥–∞ (–±–µ–∑ —Å–±—Ä–æ—Å–∞ —Ç–∞–π–º–µ—Ä–∞)
  document.getElementById('restart').onclick = () => {
    if (mode==='end') return;
    respawnRun();
  };

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  const vv = window.visualViewport;
  function setAppH(){ const h = vv?.height || window.innerHeight; document.documentElement.style.setProperty('--app-h', h+'px'); }
  setAppH(); vv?.addEventListener('resize', setAppH, {passive:true});
  resize();
  drawFrame();
  startSession();
})();
</script>
</body>
</html>
