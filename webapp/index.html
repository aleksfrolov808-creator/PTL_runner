<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>–ü—Ä–æ—Ñ–¢—Ä–µ–π–¥–õ–∞–± ‚Äî 8-bit Runner</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{--brand:#53B5AF;--bg:#000;--text:#fff;--app-h:100vh}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:monospace;background:var(--bg);color:var(--text)}
  #app{min-height:var(--app-h);display:flex;flex-direction:column}
  header{border-bottom:2px solid #1f3f3d;padding:8px 12px}
  .row{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px 12px}
  .hint{font-size:12px;opacity:.7}
  canvas{display:block;width:100%;height:auto;background:#000;touch-action:manipulation}
  .btn{border:2px solid var(--brand);background:#000;color:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
  .btn.brand{background:var(--brand);color:#000;border-color:transparent}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;z-index:10}
  .panel{background:#fff;color:#000;border:2px solid #e5e5e5;border-radius:10px;max-width:860px;width:calc(100% - 32px);padding:16px;display:grid;gap:12px;grid-template-columns:1fr 320px}
  @media (max-width:740px){.panel{grid-template-columns:1fr}}
  .field{display:grid;gap:6px}
  .field input{padding:8px;border:2px solid #e5e5e5;border-radius:8px}
  .qrbox{border:2px solid #e5e5e5;border-radius:10px;padding:12px;text-align:center}
  .qrbox img{max-width:100%;height:auto;border-radius:8px;border:1px solid #eee;background:#fff}
</style>
</head>
<body>
<div id="app">
  <header>üß™ –ü—Ä–æ—Ñ–¢—Ä–µ–π–¥–õ–∞–± 8-bit Runner</header>
  <canvas id="game" width="1200" height="420"></canvas>
  <div class="row">
    <div><span>–û—á–∫–∏: <b id="score">0</b></span> ¬∑ <span>–†–µ–∫–æ—Ä–¥: <b id="best">0</b></span> ¬∑ <span>–û—Å—Ç–∞–ª–æ—Å—å: <b id="left">02:00</b></span><div class="hint">Space/‚¨Ü/—Ç–∞–ø ‚Äî –ø—Ä—ã–∂–æ–∫, –¥–≤–æ–π–Ω–æ–π –ø—Ä—ã–∂–æ–∫ ‚Äî –≤—Ç–æ—Ä–æ–π —Å–ª–∞–±–µ–µ</div></div>
    <div>
      <button id="restart" class="btn">–ó–∞–Ω–æ–≤–æ</button>
      <button id="openReg" class="btn brand">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>
  </div>
</div>

<!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
<div id="reg" class="overlay" style="display:flex">
  <div class="panel">
    <div>
      <h3 style="margin:0 0 6px">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
      <div class="field"><label>–§–∞–º–∏–ª–∏—è *</label><input id="last" type="text"></div>
      <div class="field"><label>–ò–º—è *</label><input id="first" type="text"></div>
      <div class="field"><label>–û—Ç—á–µ—Å—Ç–≤–æ</label><input id="mid" type="text"></div>
      <div class="field"><label>–¢–µ–ª–µ—Ñ–æ–Ω *</label><input id="phone" type="tel" placeholder="+7 900 000-00-00"></div>
      <div class="field"><label>Email</label><input id="email" type="email" placeholder="name@example.com"></div>
      <label><input id="ok" type="checkbox"> –°–æ–≥–ª–∞—Å–µ–Ω –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</label>
      <div id="err" style="color:#c30000"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button id="fs" class="btn">–í–æ –≤–µ—Å—å —ç–∫—Ä–∞–Ω</button>
        <button id="go" class="btn brand">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
      </div>
    </div>
    <div class="qrbox">
      <h4 style="margin:0 0 8px">–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –≥—Ä—É–ø–ø—É</h4>
      <img src="../assets/qr_group.jpg" alt="QR –≥—Ä—É–ø–ø—ã">
      <div class="hint" style="color:#000;margin-top:6px">–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É</div>
      <button id="openGroup" class="btn brand" style="margin-top:8px">–û—Ç–∫—Ä—ã—Ç—å –≥—Ä—É–ø–ø—É</button>
    </div>
  </div>
</div>

<!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
<div id="done" class="overlay">
  <div class="panel" style="grid-template-columns:1fr">
    <div>
      <h3 style="margin:0 0 6px">–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞</h3>
      <p>–õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <b id="bestOut">0</b></p>
      <p>–ü—Ä–∏–∑: <b id="prizeOut">‚Äî</b></p>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="toReg" class="btn">–ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</button>
        <button id="send" class="btn brand">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // --- Telegram glue (–±–µ–∑–æ–ø–∞—Å–Ω–æ –≤–Ω–µ Telegram) ---
  const tg = window.Telegram && window.Telegram.WebApp;
  try{ tg?.ready(); tg?.expand(); tg?.setBackgroundColor("#000"); tg?.setHeaderColor("secondary_bg_color"); }catch(e){}

  // --- DOM ---
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const scoreEl = document.getElementById('score');
  const bestEl  = document.getElementById('best');
  const leftEl  = document.getElementById('left');
  const reg     = document.getElementById('reg');
  const done    = document.getElementById('done');
  const bestOut = document.getElementById('bestOut');
  const prizeOut= document.getElementById('prizeOut');

  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
  const last = document.getElementById('last');
  const first= document.getElementById('first');
  const mid  = document.getElementById('mid');
  const phone= document.getElementById('phone');
  const email= document.getElementById('email');
  const ok   = document.getElementById('ok');
  const err  = document.getElementById('err');

  document.getElementById('openReg').onclick = () => showReg(true);
  document.getElementById('toReg').onclick   = () => { done.style.display='none'; showReg(true); };
  document.getElementById('send').onclick    = () => { sendLead(); done.style.display='none'; showReg(true); };

  document.getElementById('openGroup').onclick = () => {
    const url = 'https://t.me/proftradelab';
    try { tg ? tg.openLink(url, {try_instant_view:false}) : window.open(url,'_blank'); } catch(e){}
  };

  document.getElementById('fs').onclick = async () => {
    try{
      if (!document.fullscreenElement) await document.documentElement.requestFullscreen();
    }catch(e){}
    resize();
  };

  document.getElementById('go').onclick = () => {
    err.textContent = '';
    const p = normPhone(phone.value);
    if (!last.value.trim())  return err.textContent = '–£–∫–∞–∂–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é';
    if (!first.value.trim()) return err.textContent = '–£–∫–∞–∂–∏—Ç–µ –∏–º—è';
    if (!p)                  return err.textContent = '–¢–µ–ª–µ—Ñ–æ–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7 900 000-00-00';
    if (!ok.checked)         return err.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ü–î';
    profile = {
      lastName: last.value.trim(),
      firstName:first.value.trim(),
      middleName: mid.value.trim(),
      phone: p,
      email: email.value.trim()
    };
    // —Å—Ç–∞—Ä—Ç
    showReg(false);
    startSession();
  };

  document.getElementById('restart').onclick = () => {
    if (mode==='play') startCountdown(3, () => beginPlay());
  };

  // --- –†–∞–∑–º–µ—Ä—ã ---
  function setAppH(){
    const h = (window.visualViewport?.height) || window.innerHeight;
    document.documentElement.style.setProperty('--app-h', h+'px');
  }
  function resize(){
    setAppH();
    const dpr = Math.min(2, window.devicePixelRatio||1);
    const w = Math.max(640, Math.floor(document.body.clientWidth));
    const h = Math.floor(Math.min(window.innerHeight, document.body.clientHeight) * 0.72);
    canvas.style.width = w+'px';
    canvas.style.height= h+'px';
    canvas.width  = Math.round(w*dpr);
    canvas.height = Math.round(h*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    W = w; H = h; GROUND = H-28;
  }
  window.addEventListener('resize', resize);
  window.addEventListener('orientationchange', resize);

  // --- –ò–≥—Ä–∞ ---
  let W=1200,H=420,GROUND=H-28;
  let mode='idle';           // idle / countdown / play / end
  let raf=0;

  let GRAVITY = 0.70;        // –∑–∞–º–µ–¥–ª–∏–ª –ø–∞–¥–µ–Ω–∏–µ
  const JUMP1  = -12.0;
  const JUMP2  = -9.0;
  const J2_WIN = 450;        // –æ–∫–Ω–æ –≤—Ç–æ—Ä–æ–≥–æ –ø—Ä—ã–∂–∫–∞
  const J2_MIN = 1.2;

  let SPEED_START = 4.6;     // –º–µ–¥–ª–µ–Ω–Ω–µ–µ —Å—Ç–∞—Ä—Ç
  const SPEED_END   = 10.0;
  const SESSION_S   = 120;
  let SPEED_A = (SPEED_END - SPEED_START)/SESSION_S;

  const SPAWN_MIN = 340, SPAWN_VAR = 300;

  let world = SPEED_START;
  let score=0, best=0, over=false, ready=false, runStart=0;
  let player = { x:56, y:GROUND-54, w:54, h:54, vy:0, on:true, jumps:0, t0:0 };
  let obs=[], spawn=0, lastType=-1;

  function startSession(){
    score=0; best=0; updateHUD();
    leftEl.textContent='02:00';
    sessionEnd = Date.now()+SESSION_S*1000;
    resetWorld();
    startCountdown(3, () => beginPlay());
  }
  function beginPlay(){
    mode='play';
    runStart=Date.now();
    tickTimer();
    loop();
  }
  function endSession(){
    if (mode!=='play') return;
    mode='end';
    bestOut.textContent = String(best);
    prizeOut.textContent= prize(best);
    sendLead(); // auto
    done.style.display='flex';
    // –∞–≤—Ç–æ-–≤–æ–∑–≤—Ä–∞—Ç –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ 1.2s ‚Äî –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å:
    setTimeout(()=>{ if(done.style.display==='flex'){ done.style.display='none'; showReg(true);} }, 1200);
  }

  function resetWorld(){
    mode='countdown'; ready=false; over=false;
    world=SPEED_START; obs.length=0; spawn=0;
    player.y=GROUND-player.h; player.vy=0; player.on=true; player.jumps=0;
    drawFrame(); // —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –Ω–µ –±—ã–ª–æ —á–µ—Ä–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
  }

  function loop(){
    cancelAnimationFrame(raf);
    raf = requestAnimationFrame(update);
  }

  function update(){
    drawFrame();
    if (mode==='play'){
      // —Ñ–∏–∑–∏–∫–∞
      player.vy += GRAVITY;
      player.y  += player.vy;
      if (player.y >= GROUND-player.h){
        player.y = GROUND-player.h;
        player.vy=0; player.on=true; player.jumps=0;
      } else player.on=false;

      // —Å–∫–æ—Ä–æ—Å—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏
      const t = (Date.now()-runStart)/1000;
      world = SPEED_START + SPEED_A*t;

      // –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
      spawn -= world;
      if (spawn<=0){
        spawnObstacle();
        const bonus = Math.random()<0.18 ? 160 : 0;
        spawn = SPAWN_MIN + Math.random()*SPAWN_VAR + bonus;
      }
      for (let i=obs.length-1;i>=0;i--){
        const o=obs[i]; o.x -= world;
        if (o.x+o.w<0) { obs.splice(i,1); continue; }
        if (!o.p && o.x+o.w<player.x){ o.p=true; score++; updateHUD(); }
        if (!over && hit(player,o)) { over=true; if (score>best){best=score; updateHUD();} }
      }
      if (over){ endSession(); return; }
      loop();
    } else if (mode==='countdown'){
      loop();
    }
  }

  function drawFrame(){
    // —Ñ–æ–Ω
    ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H);
    // –∑–µ–º–ª—è
    ctx.fillStyle='#53B5AF'; ctx.fillRect(0,GROUND,W,2);

    // –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
    ctx.fillStyle='#53B5AF';
    for (const o of obs) ctx.fillRect(o.x,o.y,o.w,o.h);

    // –∏–≥—Ä–æ–∫
    ctx.fillStyle= over ? '#ef4444' : '#a3e635';
    roundRect(ctx, player.x, player.y, player.w, player.h, 6); ctx.fill();

    // –æ–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç –ø–æ–≤–µ—Ä—Ö
    if (mode==='countdown' && !ready){
      ctx.fillStyle='rgba(0,0,0,.35)'; ctx.fillRect(0,0,W,H);
      ctx.fillStyle='#53B5AF'; ctx.font='bold 56px monospace'; ctx.textAlign='center';
      ctx.fillText(countVal>0?countVal:'', W/2, H/2);
    }
  }

  function roundRect(c,x,y,w,h,r){const rr=Math.min(r,w/2,h/2);c.beginPath();c.moveTo(x+rr,y);c.arcTo(x+w,y,x+w,y+h,rr);c.arcTo(x+w,y+h,x,y+h,rr);c.arcTo(x,y+h,x,y,rr);c.arcTo(x,y,x+w,y,rr);c.closePath();}

  // –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
  function spawnObstacle(){
    const t = chooseType();
    let w,h,y;
    if (t===0){w=50;h=50;y=GROUND-h;}         // medium
    else if(t===1){w=86;h=50;y=GROUND-h;}     // wide
    else if(t===2){w=46;h=94;y=GROUND-h;}     // high
    else {w=58;h=36;y=GROUND-90-h; if (y<16) y=16;} // fly
    obs.push({x:W+10,y,w,h,t,p:false});
  }
  function chooseType(){
    let pool=[0,1,2,3]; if (lastType!==-1) pool=pool.filter(v=>v!==lastType);
    const t=pool[(Math.random()*pool.length)|0]; lastType=t; return t;
  }

  // —Ö–∏—Ç–±–æ–∫—Å—ã ‚Äî —á—É—Ç—å –º—è–≥—á–µ
  function hit(p,o){
    const pw=p.w*0.80, ph=p.h*0.90, px=p.x+(p.w-pw)/2, py=p.y+(p.h-ph);
    const isHigh=o.t===2, ow=o.w*(isHigh?0.75:0.82), oh=o.h*(isHigh?0.66:0.78);
    const ox=o.x+(o.w-ow)/2, oy=(o.y<(GROUND-o.h)) ? (o.y+(o.h-oh)/2):(o.y+(o.h-oh));
    return px<ox+ow && px+pw>ox && py<oy+oh && py+ph>oy;
  }

  // —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
  window.addEventListener('keydown', e=>{
    if (e.code==='Space'||e.code==='ArrowUp'){ e.preventDefault(); jump(); }
  });
  canvas.addEventListener('pointerdown', jump);
  function jump(){
    if (mode!=='play') return;
    if (player.on){
      player.vy=JUMP1; player.on=false; player.jumps=1; player.t0=Date.now(); return;
    }
    const dt=Date.now()-player.t0;
    if (player.jumps===1 && dt<=J2_WIN && player.vy<J2_MIN){
      player.vy=JUMP2; player.jumps=2;
    }
  }

  // —Ç–∞–π–º–µ—Ä —Å–µ—Å—Å–∏–∏
  let sessionEnd=0, tm=0;
  function tickTimer(){
    clearInterval(tm);
    tm=setInterval(()=>{
      const left=Math.max(0, sessionEnd-Date.now());
      leftEl.textContent = fmt(left);
      if (left<=0){ clearInterval(tm); endSession(); }
    },200);
  }
  function fmt(ms){const s=Math.ceil(ms/1000), m=(s/60)|0, ss=('0'+(s%60)).slice(-2); return ('0'+m).slice(-2)+':'+ss;}

  // –æ–±—Ä–∞—Ç–Ω—ã–π —Å—á–µ—Ç
  let countVal=3;
  function startCountdown(n, cb){
    mode='countdown'; ready=false; countVal=n;
    const step=()=>{ drawFrame(); if(countVal===0){ ready=true; cb&&cb(); return; } setTimeout(()=>{countVal--; step();},500); };
    step();
  }

  // HUD
  function updateHUD(){ scoreEl.textContent=score; bestEl.textContent=best; }
  function prize(p){ if(p>=70)return'–¢–µ—Ä–º–æ—Å'; if(p>=50)return'–®–æ–ø–ø–µ—Ä'; if(p>=30)return'–ë–ª–æ–∫–Ω–æ—Ç –∏ —Ä—É—á–∫–∞'; if(p>=20)return'–ë—Ä–µ–ª–æ–∫'; return '‚Äî'; }

  // –õ–∏–¥—ã
  let profile=null;
  function sendLead(){
    if (!tg) return; // –≤–Ω–µ Telegram –ø—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º
    try{
      tg.sendData(JSON.stringify({type:'lead',profile,best,at:Date.now()}));
    }catch(e){}
  }

  // –£—Ç–∏–ª–∏—Ç—ã
  function normPhone(v){
    if(!v) return '';
    let d = v.replace(/[^\d]/g,'');
    if (d.length===11 && d[0]==='8') d='7'+d.slice(1);
    if (d.length===10) d='7'+d;
    if (d.length===11 && d[0]==='7') return '+7'+d.slice(1);
    return '';
  }
  function showReg(flag){ reg.style.display = flag?'flex':'none'; }

  // init
  const vv = window.visualViewport;
  function setAppH(){ const h = vv?.height || window.innerHeight; document.documentElement.style.setProperty('--app-h', h+'px'); }
  setAppH(); vv?.addEventListener('resize', setAppH, {passive:true});
  resize();
  showReg(true);
  drawFrame(); // –ø–µ—Ä–≤—ã–π –∫–∞–¥—Ä —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø—É—Å—Ç–æ—Ç—ã
})();
</script>
</body>
</html>
